<!DOCTYPE html>
<html lang="da" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Appcare | Nulstil kodeord</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: '#137FEC', hover: '#0F63C1', active: '#0B4490' },
                        dark: { bg: '#101922', card: '#111418', hover: '#191e24' },
                        text: { primary: '#E0E0E0', secondary: '#9DABB9' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 1s ease forwards; }
    </style>
</head>
<body class="font-sans m-0 p-0 h-screen">
    <div class="relative w-full h-screen flex justify-center items-center">
        <div class="absolute w-full h-full">
            <img src="img/login.jpg" alt="Koncert" class="w-full h-full object-cover brightness-[0.35]">
            <div class="absolute inset-0 bg-gradient-to-br from-primary/60 to-primary-active/60"></div>
        </div>

        <div class="relative z-10 w-[380px] p-[60px_50px] rounded-[20px] bg-[rgba(20,20,30,0.8)] backdrop-blur-[15px] text-center text-white shadow-[0_20px_40px_rgba(0,0,0,0.6)] animate-fade-in-up">
            <h1 class="text-5xl font-extrabold text-primary mb-2">Appcare</h1>
            <p id="welcomeText" class="text-text-secondary text-[0.95rem] mb-10">Opret ny adgangskode</p>

            <div id="loadingState" class="text-center py-5">
                <p class="text-text-secondary">Verificerer link...</p>
            </div>

            <div id="errorMessage" class="hidden bg-red-500/20 border border-red-500/50 p-4 rounded-xl mb-5">
                <p class="m-0 text-red-400" id="errorText">Ugyldigt eller udløbet link.</p>
            </div>

            <div id="successMessage" class="hidden bg-green-500/20 border border-green-500/50 p-4 rounded-xl mb-5">
                <p class="m-0 text-green-400">Din adgangskode er blevet nulstillet! Du kan nu logge ind med din nye adgangskode.</p>
            </div>

            <p id="status" class="text-red-400 text-sm min-h-[20px] mb-4"></p>

            <form class="hidden flex-col gap-5" id="resetForm">
                <input type="password" id="password" placeholder="Ny adgangskode" required minlength="8"
                    class="p-4 rounded-xl border-none bg-white/10 text-white text-base transition-all focus:outline-none focus:bg-white/20 placeholder:text-text-secondary">
                <p class="text-xs text-text-secondary text-left -mt-2 mb-2">Mindst 8 tegn</p>
                <input type="password" id="confirmPassword" placeholder="Bekræft adgangskode" required minlength="8"
                    class="p-4 rounded-xl border-none bg-white/10 text-white text-base transition-all focus:outline-none focus:bg-white/20 placeholder:text-text-secondary">
                <button id="submitBtn" type="submit"
                    class="p-4 rounded-xl border-none bg-gradient-to-br from-primary to-primary-hover text-white text-base font-semibold cursor-pointer transition-all uppercase tracking-wider hover:bg-primary-hover disabled:opacity-50">
                    Nulstil adgangskode
                </button>
            </form>

            <div class="mt-5">
                <a href="/login.html" class="text-primary no-underline hover:underline">Tilbage til login</a>
            </div>
        </div>
    </div>
    <script>
        const submitBtn = document.querySelector('#submitBtn');
        const resetForm = document.querySelector('#resetForm');
        const statusText = document.querySelector('#status');
        const successMessage = document.querySelector('#successMessage');
        const errorMessage = document.querySelector('#errorMessage');
        const errorText = document.querySelector('#errorText');
        const loadingState = document.querySelector('#loadingState');
        const welcomeText = document.querySelector('#welcomeText');

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        async function verifyToken() {
            if (!token) {
                loadingState.classList.add('hidden');
                errorText.textContent = 'Intet nulstillingstoken fundet. Anmod venligst om et nyt link.';
                errorMessage.classList.remove('hidden');
                return;
            }
            try {
                const res = await fetch(`/api/verify-reset-token?token=${encodeURIComponent(token)}`);
                const data = await res.json();
                loadingState.classList.add('hidden');
                if (data.valid) {
                    resetForm.classList.remove('hidden');
                    resetForm.classList.add('flex');
                    if (data.fornavn) welcomeText.textContent = `Hej ${data.fornavn}, opret din nye adgangskode`;
                } else {
                    errorText.textContent = data.error || 'Ugyldigt eller udløbet link. Anmod venligst om et nyt link.';
                    errorMessage.classList.remove('hidden');
                }
            } catch (error) {
                loadingState.classList.add('hidden');
                errorText.textContent = 'Der opstod en fejl. Prøv igen senere.';
                errorMessage.classList.remove('hidden');
            }
        }
        verifyToken();

        resetForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirmPassword").value;

            if (!password || !confirmPassword) { statusText.textContent = "Udfyld begge felter"; return; }
            if (password.length < 8) { statusText.textContent = "Adgangskode skal være mindst 8 tegn"; return; }
            if (password !== confirmPassword) { statusText.textContent = "Adgangskoderne stemmer ikke overens"; return; }

            submitBtn.disabled = true;
            submitBtn.textContent = "Nulstiller...";
            statusText.textContent = "";

            try {
                const res = await fetch("/api/reset-password", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token, password })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    resetForm.classList.add('hidden');
                    welcomeText.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                } else {
                    statusText.textContent = data.error || "Der opstod en fejl";
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Nulstil adgangskode";
                }
            } catch (error) {
                statusText.textContent = "Serverfejl. Prøv igen senere.";
                submitBtn.disabled = false;
                submitBtn.textContent = "Nulstil adgangskode";
            }
        });
    </script>
</body>
</html>

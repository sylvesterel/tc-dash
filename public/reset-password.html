<!DOCTYPE html>
<html lang="da">

<head>
    <meta charset="UTF-8">
    <title>Appcare | Nulstil kodeord</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style/login.css">
    <style>
        .success-message, .error-message {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }
        .success-message {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.5);
        }
        .error-message {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
        }
        .success-message.show, .error-message.show {
            display: block;
        }
        .back-link {
            margin-top: 20px;
        }
        .back-link a {
            color: var(--color-primary);
            text-decoration: none;
        }
        .back-link a:hover {
            text-decoration: underline;
        }
        #status {
            min-height: 20px;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .password-requirements {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: left;
            margin-top: -10px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
<div class="login-side">
    <div class="background">
        <img src="img/login.jpg" alt="Koncert">
        <div class="overlay"></div>
    </div>

    <div class="login-card">
        <h1>Appcare</h1>
        <p id="welcomeText">Opret ny adgangskode</p>

        <div id="loadingState" class="loading">
            <p>Verificerer link...</p>
        </div>

        <div id="errorMessage" class="error-message">
            <p style="margin: 0; color: #dc3545;" id="errorText">Ugyldigt eller udløbet link.</p>
        </div>

        <div id="successMessage" class="success-message">
            <p style="margin: 0; color: #28a745;">Din adgangskode er blevet nulstillet! Du kan nu logge ind med din nye adgangskode.</p>
        </div>

        <p id="status"></p>
        <form class="login-form" id="resetForm" style="display: none;">
            <input type="password" id="password" placeholder="Ny adgangskode" required minlength="8">
            <p class="password-requirements">Mindst 8 tegn</p>
            <input type="password" id="confirmPassword" placeholder="Bekræft adgangskode" required minlength="8">
            <button id="submitBtn" type="submit">Nulstil adgangskode</button>
        </form>

        <div class="login-links back-link">
            <a href="/login.html">Tilbage til login</a>
        </div>
    </div>
</div>
<script>
const submitBtn = document.querySelector('#submitBtn');
const resetForm = document.querySelector('#resetForm');
const statusText = document.querySelector('#status');
const successMessage = document.querySelector('#successMessage');
const errorMessage = document.querySelector('#errorMessage');
const errorText = document.querySelector('#errorText');
const loadingState = document.querySelector('#loadingState');
const welcomeText = document.querySelector('#welcomeText');

// Get token from URL
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');

// Verify token on page load
async function verifyToken() {
    if (!token) {
        loadingState.style.display = 'none';
        errorText.textContent = 'Intet nulstillingstoken fundet. Anmod venligst om et nyt link.';
        errorMessage.classList.add('show');
        return;
    }

    try {
        const res = await fetch(`/api/verify-reset-token?token=${encodeURIComponent(token)}`);
        const data = await res.json();

        loadingState.style.display = 'none';

        if (data.valid) {
            resetForm.style.display = 'flex';
            if (data.fornavn) {
                welcomeText.textContent = `Hej ${data.fornavn}, opret din nye adgangskode`;
            }
        } else {
            errorText.textContent = data.error || 'Ugyldigt eller udløbet link. Anmod venligst om et nyt link.';
            errorMessage.classList.add('show');
        }
    } catch (error) {
        loadingState.style.display = 'none';
        errorText.textContent = 'Der opstod en fejl. Prøv igen senere.';
        errorMessage.classList.add('show');
    }
}

verifyToken();

resetForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    if (!password || !confirmPassword) {
        statusText.textContent = "Udfyld begge felter";
        return;
    }

    if (password.length < 8) {
        statusText.textContent = "Adgangskode skal være mindst 8 tegn";
        return;
    }

    if (password !== confirmPassword) {
        statusText.textContent = "Adgangskoderne stemmer ikke overens";
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Nulstiller...";
    statusText.textContent = "";

    try {
        const res = await fetch("/api/reset-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, password })
        });

        const data = await res.json();

        if (res.ok && data.success) {
            resetForm.style.display = 'none';
            welcomeText.style.display = 'none';
            successMessage.classList.add('show');
        } else {
            statusText.textContent = data.error || "Der opstod en fejl";
            submitBtn.disabled = false;
            submitBtn.textContent = "Nulstil adgangskode";
        }
    } catch (error) {
        statusText.textContent = "Serverfejl. Prøv igen senere.";
        submitBtn.disabled = false;
        submitBtn.textContent = "Nulstil adgangskode";
    }
});
</script>
</body>

</html>
